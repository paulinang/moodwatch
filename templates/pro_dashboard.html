{% extends 'base.html' %}

{% block content %}
    <div class='container-fluid'>
        <h1>{{ pro.username }}'s Dashboard </h1>
        <h3><a href='/drugs'>Psychiatric Medications Database</a></h3>

        <div class='row' id='select-client'>
            <div class='col-xs-12'>
                <label for='client-to-view'>Client:</label>
                <select id='client-to-view' name='client-id'>
                    <option selected='selected' disabled>Select client</option>
                    {% for client in pro.professional.sort_clients().active %}
                        <option value='{{ client.user_id }}'>{{ client.username }}</option>
                    {% endfor %}
            </select>
            </div>
        </div>

        <div class='row client-details' id='client-chart'>
            <div class='col-xs-12'>
                <h3>Client Logs</h3>
                <div class="mood-chart" style='height: 50vh; width: 75vw'>
                  <canvas id="moodChart"></canvas>
                </div>
            </div>
        </div>
        
        <div class='row client-details' id='client-meds'>
            <div class='col-xs-12'>
                <h3 id='client-name'></h3>
                <h5>Client Prescriptions</h5>
                <ul id='client-meds'></ul>
            </div>
        </div>
    </div>

    <!-- Add Prescription Modal -->
    <div class="modal fade" id="change-prescription-modal" tabindex="-1" role="dialog" aria-labelledby="change-prescription-modal">
      <div class="modal-dialog" role="document">

        <div class="modal-content">
          <div class="modal-header">
            <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
            <h4 class="modal-title" id="change-prescription-title">Change Prescription </h4>
          </div>
          <div class="modal-body">
            <form id='change-prescription' action='/add_prescription' method='POST'>
                <label for='instructions'>Instructions: </label>
                <input id='instructions' type='text' name='instructions' required><br>

                <label for='notes'>Notes: </label>
                <input id='notes' type='text' name='notes' required><br>

                <input id='start-date' type='hidden'>
                clickedPrescriptionId: <input id='old-prescription' type='text'> 
                <input id='drug-id' type='text'>
                <input id='client-id' type='text'>
                <input type='submit' value='Change Prescription'>

            </form>             

            <link rel="stylesheet" href="//code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css">
            <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.js"></script>
            <script>


            </script>
          </div>
        </div>
      </div>
    </div>


    <script src='static/main.js'></script>
    <script src='static/mood_chart.js'></script>
    <script>

        // Set vars for client chart
        var ctx = $('#moodChart').get(0).getContext('2d');
        var moodChart;

        var currentClient;
        $('#client-to-view').on('change', function(evt){
            currentClient = this.value;
            showClientData(currentClient, '{{ pro.username }}');
        });

        $( function() {
            var currentDate = moment().format('YYYY-MM-DD');
            $( "#start-date" ).val(currentDate);
        });

        $('#change-prescription-modal').on('show.bs.modal', function(evt) {
            var button = $(evt.relatedTarget);
            $('#old-prescription').val(button[0].dataset['prescriptionId']);
            $('#drug-id').val(button[0].dataset['drugId']);
            $('#client-id').val(currentClient);


            $('#change-prescription').on('submit', function(evt) {
                evt.preventDefault();
                // debugger;
                formInputs = {
                    clientId: $('#client-id').val(),
                    drugId: $('#drug-id').val(),
                    instructions: $('#instructions').val(),
                    notes: $('#notes').val(),
                    startDate: $('#start-date').val()
                }
                // debugger;
                endPrescription($('#old-prescription').val());
                addPrescription(formInputs);
                showClientData($('#client-id').val(), '{{ pro.username }}');
            });
        });
    </script>
{% endblock %}